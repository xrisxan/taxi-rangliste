<script>
let fahrten = [];
let fahrzeuge = [];
let ziele = [];  // Ziele hinzufügen

/* ========= DEV ========= */
const DEV_PW = "1234";
let dev = false;
let pending = null;

function requestDev(action) {
    if (dev) return exec(action);
    pending = action;
    overlay.style.display = devModal.style.display = "block";
}
function confirmDev() {
    if (devPw.value === DEV_PW) {
        dev = true;
        overlay.style.display = devModal.style.display = "none";
        exec(pending);
    } else alert("Falsch");
    devPw.value = "";
}
function exec(a) {
    if (a === "clear" && confirm("Alles löschen?")) {
        // C#: clearAll
        chrome.webview.postMessage({ type: "clearAll" });
    }
}

/* ========= C# <-> JS ========= */

// Nachrichten von C# empfangen
window.chrome.webview.addEventListener('message', event => {
    const msg = event.data;
    if (!msg || !msg.type) return;

    switch (msg.type) {
        case "initData":
            fahrzeuge = msg.payload.fahrzeuge || [];
            fahrten = msg.payload.fahrten || [];
            ziele = msg.payload.ziele || [];  // Ziele speichern
            render();
            break;

        case "fahrtenUpdated":
            fahrten = msg.payload || [];
            render();
            break;

        case "error":
            alert(msg.payload || "Unbekannter Fehler");
            break;
    }
});

// Beim Eingeben des Ziels den Preis automatisch übernehmen
document.getElementById('z').addEventListener('input', (e) => {
    const zVal = e.target.value.trim();
    const ziel = ziele.find(z => z.z.toLowerCase() === zVal.toLowerCase());
    if (ziel) {
        document.getElementById('b').value = ziel.p.toFixed(2);
    }
});

/* ========= LOGIK ========= */

function add() {
    const wv = w.value.trim();
    const zv = z.value.trim();
    const bv = parseFloat(b.value);

    if (!wv) return alert("Wagen fehlt");
    if (isNaN(bv)) return alert("Betrag ungültig");

    // Fahrt an C# schicken
    chrome.webview.postMessage({
        type: "saveFahrt",
        payload: { w: wv, z: zv, b: bv }
    });

    w.value = z.value = b.value = "";
}

function render() {
    // Tabelle
    tbody.innerHTML = [...fahrten].reverse().map(f => `
        <tr>
            <td>${f.w}</td>
            <td>${f.u}</td>
            <td>${f.z}</td>
            <td>${Number(f.b).toFixed(2)} €</td>
            <td>${f.t}</td>
            <td></td>
        </tr>`).join("");

    // Rangliste
    const stats = {};
    const count = {};
    fahrzeuge.forEach(f => count[f.u] = (count[f.u] || 0) + 1);
    fahrten.forEach(f => stats[f.u] = (stats[f.u] || 0) + Number(f.b));

    rangliste.innerHTML = Object.keys(count).map(u => {
        const avg = (stats[u] || 0) / count[u];
        return `<div class="rangliste-item">
            <b>${u}</b><br>Ø ${avg.toFixed(2)} €
        </div>`;
    }).join("");
}
</script>
