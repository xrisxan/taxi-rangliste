<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Taxi Rangliste â€“ Unternehmer (Ã˜ pro Wagen)</title>

<style>
/* Dein bestehendes CSS bleibt hier */
</style>
</head>
<body>

<div id="overlay"></div>
<div id="devModal">
    <h3>Entwickler-Zugriff</h3>
    <input type="password" id="devPw" placeholder="Passwort">
    <button class="btn" onclick="confirmDev()">OK</button>
</div>

<header>
    <h2>Taxi Rangliste â€“ Ã˜ Einnahmen pro Wagen</h2>
    <div class="rangliste-bar" id="rangliste"></div>
</header>

<div class="main">
    <div class="sidebar">
        <h3>Fahrt erfassen</h3>

        <div class="input-group">
            <label>Wagen</label>
            <input id="w" autofocus>
        </div>

        <div class="input-group">
            <label>Ziel</label>
            <input id="z">
        </div>

        <div class="input-group">
            <label>Betrag (â‚¬)</label>
            <input id="b" type="number" step="0.01">
        </div>

        <button class="btn" onclick="add()">Speichern</button>

        <div class="nav">
            <a href="zg.html" class="nav-link">ğŸš— Fahrzeuge</a>
            <a href="ziele.html" class="nav-link">ğŸ“ Ziele</a>
            <a href="#" onclick="requestDev('clear')">ğŸ—‘ï¸ Alles lÃ¶schen</a>
        </div>
    </div>

    <div class="content">
        <div class="table-box">
            <table>
                <thead>
                <tr>
                    <th>Wagen</th>
                    <th>Unternehmer</th>
                    <th>Ziel</th>
                    <th>Betrag</th>
                    <th>Zeit</th>
                    <th>Aktion</th>
                </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let fahrten = [];
let fahrzeuge = [];
let ziele = [];  // Ziele hinzufÃ¼gen

// Nachrichten von C# empfangen
window.chrome.webview.addEventListener('message', event => {
    const msg = event.data;
    if (!msg || !msg.type) return;

    switch (msg.type) {
        case "initData":
            fahrzeuge = msg.payload.fahrzeuge || [];
            fahrten = msg.payload.fahrten || [];
            ziele = msg.payload.ziele || [];  // Ziele speichern
            render();
            break;

        case "fahrtenUpdated":
            fahrten = msg.payload || [];
            render();
            break;

        case "error":
            alert(msg.payload || "Unbekannter Fehler");
            break;
    }
});

// Beim Eingeben des Ziels den Preis automatisch Ã¼bernehmen
document.getElementById('z').addEventListener('input', (e) => {
    const zVal = e.target.value.trim();
    const ziel = ziele.find(z => z.z.toLowerCase() === zVal.toLowerCase());
    if (ziel) {
        document.getElementById('b').value = ziel.p.toFixed(2);
    }
});

/* ========= Logik und Navigation ========= */

function add() {
    const wv = w.value.trim();
    const zv = z.value.trim();
    const bv = parseFloat(b.value);

    if (!wv) return alert("Wagen fehlt");
    if (isNaN(bv)) return alert("Betrag ungÃ¼ltig");

    chrome.webview.postMessage({
        type: "saveFahrt",
        payload: { w: wv, z: zv, b: bv }
    });

    w.value = z.value = b.value = "";
}

document.getElementById('w').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('z').focus();
    }
});

document.getElementById('z').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('b').focus();
    }
});

document.getElementById('b').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        add();
    }
});

function render() {
    tbody.innerHTML = [...fahrten].reverse().map(f => `
        <tr>
            <td>${f.w}</td>
            <td>${f.u}</td>
            <td>${f.z}</td>
            <td>${Number(f.b).toFixed(2)} â‚¬</td>
            <td>${f.t}</td>
            <td></td>
        </tr>`).join("");

    const stats = {};
    const count = {};
    fahrzeuge.forEach(f => count[f.u] = (count[f.u] || 0) + 1);
    fahrten.forEach(f => stats[f.u] = (stats[f.u] || 0) + Number(f.b));

    rangliste.innerHTML = Object.keys(count).map(u => {
        const avg = (stats[u] || 0) / count[u];
        return `<div class="rangliste-item">
            <b>${u}</b><br>Ã˜ ${avg.toFixed(2)} â‚¬
        </div>`;
    }).join("");
}

document.addEventListener('DOMContentLoaded', () => {
    chrome.webview.postMessage({ type: "init" });
});
</script>
</body>
</html>
