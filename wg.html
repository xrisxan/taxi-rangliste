<script>
    const wNrInput = document.getElementById('wNr');
    const uNameInput = document.getElementById('uName');
    const scrollContainer = document.getElementById('scrollContainer');

    let fahrzeuge = [];      // { W, U } aus C#
    let editOldWNr = null;   // alte Wagennummer beim Bearbeiten

    function scrollToBottom() {
        setTimeout(() => {
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }, 50);
    }

    function loadEntry(index) {
        const item = fahrzeuge[index];
        if (!item) return;

        const w = item.W != null ? item.W : item.w;
        const u = item.U != null ? item.U : item.u;

        wNrInput.value = w;
        uNameInput.value = u;
        editOldWNr = w;
        wNrInput.select();
    }

    // Speichern beim Verlassen des Namensfeldes
    uNameInput.addEventListener('blur', () => {
        if (uNameInput.value.trim() !== "" && wNrInput.value.trim() !== "") {
            saveEntry();
        }
    });

    // Enter Navigation
    wNrInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            uNameInput.focus();
        }
    });

    uNameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEntry();
            wNrInput.focus();
        }
    });

    function saveEntry() {
        const w = wNrInput.value.trim();
        const u = uNameInput.value.trim();

        if (!w || !u) return;

        if (window.chrome && window.chrome.webview) {
            chrome.webview.postMessage({
                type: "saveFahrzeug",
                payload: { w: w, u: u, oldW: editOldWNr }
            });
        } else {
            alert("Speichern nur in der Desktop-App möglich.");
        }

        wNrInput.value = "";
        uNameInput.value = "";
        editOldWNr = null;
    }

    function renderTable() {
        const tbody = document.querySelector('#wgTable tbody');
        tbody.innerHTML = fahrzeuge.map((f, i) => {
            const w = f.W != null ? f.W : f.w;
            const u = f.U != null ? f.U : f.u;
            return `
            <tr onclick="loadEntry(${i})">
                <td><strong>${w}</strong></td>
                <td>${u}</td>
                <td>
                    <button class="btn-del"
                        onclick="event.stopPropagation(); deleteEntry('${w}')">
                        Löschen
                    </button>
                </td>
            </tr>`;
        }).join('');
        scrollToBottom();
    }

    function deleteEntry(wagenNr) {
        if (!confirm("Soll dieses Fahrzeug wirklich dauerhaft gelöscht werden?")) return;

        if (window.chrome && window.chrome.webview) {
            chrome.webview.postMessage({
                type: "deleteFahrzeug",
                payload: { w: wagenNr }
            });
        } else {
            alert("Löschen nur in der Desktop-App möglich.");
        }
    }

    // Nachrichten von C# empfangen
    if (window.chrome && window.chrome.webview) {
        window.chrome.webview.addEventListener('message', event => {
            const msg = event.data;
            if (!msg || !msg.type) return;

            switch (msg.type) {
                case "fahrzeugeLoaded":
                    fahrzeuge = msg.payload || [];
                    renderTable();
                    break;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            chrome.webview.postMessage({ type: "loadFahrzeuge" });
        });
    }

    // globale Funktionen für onclick
    window.loadEntry = loadEntry;
    window.deleteEntry = deleteEntry;
</script>
